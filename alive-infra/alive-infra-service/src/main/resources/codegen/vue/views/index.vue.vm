<script setup lang="ts">
import { Plus, EditPen, Delete } from '@element-plus/icons-vue'
import { dateFormatter } from '@/utils/date'
import { DICT_TYPE, getIntDictOptions } from '@/utils/dict'
import * as ${table.className}Api from '@/api/${table.moduleName}/${table.businessName}'
import ${table.className}Form from './${table.className}Form.vue'

defineOptions({ name: '${table.className}' })

const aliveTable = ref()
const message = useMessage()
const formRef = ref()
const openForm = (id?: number) => {
  formRef.value.open(id, aliveTable.value.getTableList)
}

#set($hasDataSearch = false)
#foreach ($column in $columns)
  #if ($column.queryCondition && ($column.queryType == 'BETWEEN_DATE' || $column.queryType == 'BETWEEN'))
const getTableList = (params: any) => {
  let newParams = JSON.parse(JSON.stringify(params))
  newParams.createDate && (newParams.startDate = newParams.createDate[0])
  newParams.createDate && (newParams.endDate = newParams.createDate[1])
  delete newParams.createDate
  return ${table.className}Api.get${simpleClassName}Page(newParams)
}
      #set($hasDataSearch = true)
    #break
  #end
#end

const handleDel = async (id: number) => {
  try {
    await message.delConfirm()
    await ${table.className}Api.del${simpleClassName}(id)
    message.success('删除成功')
    await aliveTable.value.getTableList()
  } catch {}
}
</script>

<template>
  <div class="table-box">
    <AliveTable ref="aliveTable" :request-api="#if($hasDataSearch == true)getTableList#else${table.className}Api.get${simpleClassName}Page#end">
      <template #search>
        #foreach($column in $columns)
          #if($column.queryCondition)
            #set ($dictType = $column.dictType)
            #set ($javaField = $column.javaField)
            #set ($javaType = $column.javaType)
            #set ($AttrName = $column.javaField.substring(0,1).toUpperCase() + ${column.javaField.substring(1)})
            #set ($comment = $column.columnComment)
            #set ($dictMethod = "getDictOptions")## 计算使用哪个 dict 字典方法
            #if ($javaType == "Integer" || $javaType == "Long" || $javaType == "Byte" || $javaType == "Short")
              #set ($dictMethod = "getIntDictOptions")
            #elseif ($javaType == "String")
              #set ($dictMethod = "getStrDictOptions")
            #elseif ($javaType == "Boolean")
              #set ($dictMethod = "getBoolDictOptions")
            #end
            #if ($column.htmlType == "input")
        <el-form-item label="${comment}" prop="${javaField}">
          <el-input v-model="aliveTable.searchParam.${javaField}" placeholder="请输入${comment}" clearable />
        </el-form-item>
            #elseif($column.htmlType == "select" || $column.htmlType == "radio")
        <el-form-item label="${comment}" prop="${javaField}">
          <el-select v-model="aliveTable.searchParam.${javaField}" placeholder="请选择${comment}" clearable>
            #if ("" != $dictType)
            <el-option
              v-for="(item, index) in getIntDictOptions(DICT_TYPE.$dictType.toUpperCase())"
              :key="index"
              :label="item.label"
              :value="item.value"
            />
            #else
            <el-option label="请选择字典生成" value="" />
            #end
          </el-select>
        </el-form-item>
          #elseif($column.htmlType == "datetime")
        <el-form-item label="${comment}" prop="${javaField}">
              #if ($column.queryType != "BETWEEN" && $column.queryType != "BETWEEN_DATE")
          <el-date-picker
            v-model="aliveTable.searchParam.${javaField}"
            value-format="YYYY-MM-DD"
            range-separator="至"
            placeholder="请选择${comment}"
          />
              #else
          <el-date-picker
            v-model="aliveTable.searchParam.createDate"
            value-format="YYYY-MM-DD"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
          />
              #end
        </el-form-item>
            #end
          #end
        #end
      </template>

      <template #operation>
        <el-button type="primary" :icon="Plus" @click="openForm(undefined)">添加${table.classComment}</el-button>
      </template>

        #foreach($column in $columns)
          #if($column.queryResult)
            #set ($dictType=$column.dictType)
            #set ($javaField = $column.javaField)
            #set ($AttrName=$column.javaField.substring(0,1).toUpperCase() + ${column.javaField.substring(1)})
            #set ($comment=$column.columnComment)
            #if ($column.javaType == "LocalDateTime")## 时间类型
      <el-table-column align="center" label="${comment}" prop="${javaField}" :formatter="dateFormatter" width="300" />
            #elseif($column.dictType && "" != $column.dictType)
      <el-table-column align="center" label="${comment}" prop="${javaField}" width="150">
        <template #default="{ row }">
            <Tag :type="DICT_TYPE.$dictType.toUpperCase()" :value="row.${column.javaField}" />
        </template>
      </el-table-column>
            #else
      <el-table-column label="${comment}" align="center" prop="${javaField}" />
            #end
          #end
        #end

      <el-table-column align="center" label="操作" width="200">
        <template #default="{ row }">
          <el-button :icon="EditPen" link type="primary" size="small" @click="openForm(row.id)"> 编辑 </el-button>
          <el-divider direction="vertical" />
          <el-button :icon="Delete" link type="danger" size="small" @click="handleDel(row.id)"> 删除 </el-button>
        </template>
      </el-table-column>
    </AliveTable>
  </div>
  <${table.className}Form ref="formRef" />
</template>
